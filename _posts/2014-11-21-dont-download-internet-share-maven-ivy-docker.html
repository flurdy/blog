---
layout: post
title: 'Don''t download the internet. Share Maven and Ivy repositories with Docker
  containers '
date: '2014-11-21T14:09:00.001Z'
author: flurdy
tags:
- docker
- code
- ivy
- maven
- virtualization
modified_time: '2014-12-21T03:50:42.428Z'
blogger_id: tag:blogger.com,1999:blog-4019909.post-7446925040853131735
blogger_orig_url: http://blog.flurdy.com/2014/11/dont-download-internet-share-maven-ivy-docker.html
---

<span style="font-family: Verdana, sans-serif;"><a href="https://duckduckgo.com/?q=downloading+the+internet+maven+!gi">Downloading the internet</a>. A term commonly used when building&nbsp;<a href="http://maven.apache.org/">Maven</a>&nbsp;projects. It is due to downloading your applications dependencies and their transitive dependencies. With a normal application those dependencies can add up to quite a few jars and a lot of megabytes to download. Especially on a 'clean' machine without cached dependencies in your local repository.</span><br /><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Running a new container in&nbsp;<a href="http://docker.com/">Docker</a>&nbsp;sometimes feels the same as every&nbsp;<a href="https://docs.docker.com/terms/image/">image layer</a>&nbsp;it is built on top of also has to be downloaded. Eventually these are also cached in the Docker cache.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">If you then have a Maven based application in Docker you have the perfect storm of bandwidth hogging. Especially as your Docker image's Maven configuration will by default not reuse any cached dependencies and instead always download everything from Maven Central. And for each new build or launch it will re-download the internet as it knows of no local cached dependencies.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Work around, not solution</span></h4></div><div><span style="font-family: Verdana, sans-serif;">My work around is to mount my local host repositories for Maven, and for its derivative&nbsp;<a href="http://ant.apache.org/ivy/">Ivy</a>, as data volumes for the Docker container. This then avoids re-downloading the internet on every further build and launch and will also reuse dependencies I most likely have already downloaded on the host.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">It is not the best solution as your images should ideally not be influenced by what you have on your host machine, but it saves a lot of time, and a lot of grief.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Vagrant</span></h4></div><div><span style="font-family: Verdana, sans-serif;">When I run my docker containers inside a&nbsp;<a href="http://vagrantup.com/">Vagrant</a>&nbsp;instance I first mount my host repositories by adding these 2 lines to the&nbsp;<i>Vagrantfile:</i></span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">config.vm.synced_folder "/Users/myusername/.m2", "/home/vagrant/.m2"</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">config.vm.synced_folder "/Users/myusername/.ivy2", "/home/vagrant/.ivy2"</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><br /><h4><span style="font-family: Verdana, sans-serif;">Boot2docker</span></h4></div><div><span style="font-family: Verdana, sans-serif;">Since Docker 1.3 the OSX <i>/Users</i> path has been by default shared with the boot2docker VM on the same path. So to share the maven repositories you need to link the /Users path to your docker user home folder.</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;boot2docker ssh;</span><br /><span style="font-family: Courier New, Courier, monospace;"><br class="Apple-interchange-newline" />&nbsp; &nbsp;ln -s /Users/mysername/.m2 /home/docker/.m2;</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;ln -s /Users/mysername/.ivy2 /home/docker/.ivy2</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Data volume container</span></h4></div><div><span style="font-family: Verdana, sans-serif;">For easy sharing these folders between many docker containers I mount them as a data volume container and naming it ‘<i>maven</i>’.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;docker run -d -P --name maven \</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;-v ~/.m2:/root/.m2:rw \</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;-v ~/.ivy2:/root/.ivy2:rw ubuntu</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">I am basing it on the basic&nbsp;<a href="http://ubuntu.com/">Ubuntu</a>&nbsp;image, and it will stop immediately as no process is running. That is fine, the mounted volumes will still work.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Alternatively instead of mounting the host folders you can have a persistent container with these folders exposed as&nbsp;<a href="https://docs.docker.com/reference/builder/#volume">VOLUME</a>&nbsp;in the Dockerfile so it is shared in a similar manner.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Launch container&nbsp;</span></h4></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp;&nbsp;</span><span style="font-family: Courier New, Courier, monospace;">&nbsp;docker run -d --volumes-from maven \</span><br /><span style="font-family: Courier New, Courier, monospace;"><i>&nbsp; &nbsp;yourapplicationimage</i></span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Obviously you probably have other options on your docker launch, but the important bit here is the ‘--volumes-from maven’ which maps all the volumes from the data volume container called maven into this container.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Now in theory all containers with Maven and Ivy based build tools such as&nbsp;<a href="http://www.scala-sbt.org/">SBT</a>&nbsp;should first look at the mounted Maven and Ivy repositories for their dependencies.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Build problem</span></h4></div><div><span style="font-family: Verdana, sans-serif;">Unfortunately if you build new images frequently you will have the same problem still as the above solution is only for running containers not building. During the build stage Docker does not allow you mount any volumes. This is so it is reproducible anywhere.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">In your&nbsp;<i>Dockerfile</i>&nbsp;you can ADD or COPY whole repositories into your image, but that will make it very bloated with a lot of irrelevant dependencies unless you somehow construct and maintain a perfect repository. (Ps. don’t do this).</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Maven repository manager</span></h4></div><div><span style="font-family: Verdana, sans-serif;">One solution that makes sense in general is to add you companies&nbsp;<a href="http://maven.apache.org/repository-management.html">Maven repository manager</a>’s public&nbsp;<i>Maven Central&nbsp;</i>mirror to the image. That way at least you will only download the intranet, not the internet.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">For a Maven build add a&nbsp;<i>settings.xml</i>&nbsp;file to your image folder with at least these settings if using&nbsp;<a href="http://www.sonatype.com/nexus">Nexus</a>:</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&lt;mirrors</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">mirror</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">id</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><span style="font-family: Courier New, Courier, monospace;">Nexus</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/id</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">name</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><span style="font-family: Courier New, Courier, monospace;">Nexus Public Mirror</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/name</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">url</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><span style="font-family: Courier New, Courier, monospace;">http://nexusmachine/nexus/content/groups/public</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/url</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">mirrorOf</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><span style="font-family: Courier New, Courier, monospace;">central</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/mirrorOf</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/mirror</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&lt;</span><span style="font-family: Courier New, Courier, monospace;">/mirrors</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span></div><div><span style="font-family: Verdana, sans-serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="font-family: Verdana, sans-serif;">&nbsp; &nbsp; &nbsp; &nbsp;</span></div><div><span style="font-family: Verdana, sans-serif;">Then add this to your&nbsp;<i>Dockerfile</i>:</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp;</span><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;ADD settings.xml /root/.m2/settings.xml</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Note this will be overwritten if you later during the run stage mount&nbsp;<i>.m2</i>&nbsp;folder on top of it, but for most that is fine as the&nbsp;<i>.m2</i>&nbsp;folder usually contain a relevant&nbsp;<i>settings.xml&nbsp;</i>file anyway.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">For a&nbsp;<a href="http://www.scala-sbt.org/">SBT</a>&nbsp;build add this repositories file to your image folder with this content:</span><br /><span style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><blockquote class="tr_bq"><span style="font-family: 'Courier New', Courier, monospace;">[repositories]</span></blockquote><blockquote class="tr_bq"><span style="font-family: 'Courier New', Courier, monospace;">local</span>&nbsp;</blockquote><blockquote class="tr_bq"><span style="font-family: 'Courier New', Courier, monospace;"></span><span style="font-family: 'Courier New', Courier, monospace;">maven-local</span></blockquote><blockquote class="tr_bq"><span style="font-family: 'Courier New', Courier, monospace;">company-repo: http://nexusmachine/nexus/content/groups/public</span></blockquote><blockquote class="tr_bq"><span style="font-family: 'Courier New', Courier, monospace;"></span><span style="font-family: 'Courier New', Courier, monospace;">scala-tools-releases</span></blockquote><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;">maven-centra</span><span style="font-family: Verdana, sans-serif;">l</span></blockquote></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Then add this to your Dockerfile:</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;ADD repositories /root/.sbt/repositories</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><h4><span style="font-family: Verdana, sans-serif;">Repository manager container</span></h4></div><div><span style="font-family: Verdana, sans-serif;">A further solution is to run a repository manager as another container and have all Maven/SBT builds refer to it instead. This avoids the involvement of the host computer yet saves any network traffic as everything is localhost.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Pull down something like&nbsp;<a href="https://registry.hub.docker.com/u/mattgruter/artifactory/">https://registry.hub.docker.com/u/mattgruter/artifactory/</a>&nbsp;.</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; docker pull mattgruter/artifactory</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Configure then run and name it:</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp;&nbsp;</span><span style="font-family: Courier New, Courier, monospace;">&nbsp; docker run -d --name artifactory \</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; mattgruter/artifactory</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">Modify the above settings.xml and repositories to refer to you locally linked artifactory name as url instead, e.g this one liner:</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;<span style="font-size: x-small;">&nbsp;company-ivy-repo: http://artifactory/artifactory/repo/,</span></span><br /><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp;[organization]/[module]/[revision]/[type]s/[artifact](-[classifier]).[ext]</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace; font-size: x-small;">&nbsp;company-repo: http://artifactory/artifactory/repo/</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><div><span style="font-family: Verdana, sans-serif;">(The example above added it as an Ivy repository which&nbsp;<a href="http://www.jfrog.com/artifactory/">Artifactory</a>&nbsp;supports).</span></div><div><span style="font-family: Verdana, sans-serif;"><br /></span></div><br /><div></div><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: Times; font-size: medium; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px;"><div style="margin: 0px;"><span style="font-family: Verdana, sans-serif;">Hopefully these tips will avoid downloading the internet too often and save a few grey hairs.</span></div></div>